<body>
    <div id="gameDiv">
    </div>
</body>
<canvas id="meter" width="500" height="50"></canvas>
<script src="client/lib/phaser.min.js"></script>
<script src="http://localhost:<62143>/socket.io/socket.js"></script>
<script src="client/player.js"></script>
<script src="client/main.js"></script>
<script src="volume.js"></script>
<script src="gyro.min.js"></script>
<script>
    var audioContext = null;
    var meter = null;
    var canvasContext = null;
    var WIDTH = 500;
    var HEIGHT = 50;
    var rafID = null;

    window.onload = function() {

        if ("vibrate" in window.navigator) {
            window.navigator.vibrate(100);
        }

        // grab our canvas
        canvasContext = document.getElementById("meter").getContext("2d");

        // monkeypatch Web Audio
        window.AudioContext = window.AudioContext || window.webkitAudioContext;

        // grab an audio context
        audioContext = new AudioContext();

        // Attempt to get audio input
        try {
            // monkeypatch getUserMedia
            navigator.getUserMedia =
                navigator.getUserMedia ||
                navigator.webkitGetUserMedia ||
                navigator.mozGetUserMedia ||
                navigator.msGetUserMedia);

        // ask for an audio input
        navigator.getUserMedia({
            "audio": {
                "mandatory": {
                    "googEchoCancellation": "false",
                    "googAutoGainControl": "false",
                    "googNoiseSuppression": "false",
                    "googHighpassFilter": "false"
                },
                "optional": []
            },
        }, onMicrophoneGranted, onMicrophoneDenied);
    } catch (e) {
        alert('getUserMedia threw exception :' + e);
    }

    }

    function onMicrophoneDenied() {
        alert('Stream generation failed.');
    }

    var mediaStreamSource = null;

    function onMicrophoneGranted(stream) {
        // Create an AudioNode from the stream.
        mediaStreamSource = audioContext.createMediaStreamSource(stream);

        // Create a new volume meter and connect it.
        meter = createAudioMeter(audioContext);
        mediaStreamSource.connect(meter);

        // kick off the visual updating
        onLevelChange();
    }

    function onLevelChange(time) {
        // clear the background
        canvasContext.clearRect(0, 0, WIDTH, HEIGHT);

        // check if we're currently clipping
        if (meter.checkClipping()) {
            //window.navigator.vibrate([1000, 2000, 1000]);
            canvasContext.fillStyle = "red";
        } else
            canvasContext.fillStyle = "green";

        console.log(meter.volume);
        if (meter.volume >= 0.001) {
            window.navigator.vibrate([1000, 2000, 1000]);
            console.log("hmm");
        }

        // draw a bar based on the current volume
        canvasContext.fillRect(0, 0, meter.volume * WIDTH * 1.4, HEIGHT);

        // set up the next visual callback
        rafID = window.requestAnimationFrame(onLevelChange);
    }

</script>
